<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Owner Column</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ "–í–ª–∞–¥–µ–ª–µ—Ü" –≤ —Ç–µ—Å—Ç-–∫–µ–π—Å–∞—Ö</h1>

    <div id="status" class="test-result">
        üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API...
    </div>

    <div id="testResults"></div>

    <script src="frontend/js/api.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('testResults');

        async function runTests() {
            try {
                // Test 1: Check API connection
                const healthResponse = await fetch('http://localhost:3000/health');
                if (!healthResponse.ok) throw new Error('Server not responding');

                statusDiv.className = 'test-result success';
                statusDiv.innerHTML = '‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';

                // Test 2: Login as admin
                const loginResult = await window.api.login({
                    username: 'admin',
                    password: 'admin123'
                });

                if (!loginResult.success) throw new Error('Login failed');

                // Test 3: Get test cases
                const testCasesResult = await window.api.getTestCases();

                if (!testCasesResult.success) throw new Error('Failed to get test cases');

                const testCases = testCasesResult.data || [];

                // Test 4: Check if owner column data is present
                let results = '<h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h2>';

                if (testCases.length === 0) {
                    results += '<div class="test-result error">‚ùå –ù–µ—Ç —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</div>';
                    results += '<p>–°–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ—Å—Ç-–∫–µ–π—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–æ–Ω–∫–∏ "–í–ª–∞–¥–µ–ª–µ—Ü"</p>';
                } else {
                    results += `<div class="test-result success">‚úÖ –ù–∞–π–¥–µ–Ω–æ ${testCases.length} —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤</div>`;

                    results += '<h3>üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤:</h3>';
                    results += '<table>';
                    results += '<tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>created_by</th><th>created_by_username</th><th>assigned_to</th><th>assigned_to_username</th><th>–°—Ç–∞—Ç—É—Å</th></tr>';

                    testCases.forEach(tc => {
                        const ownerStatus = tc.created_by_username ? '‚úÖ' : '‚ùå';
                        const assigneeStatus = tc.assigned_to_username || tc.assigned_to ? '‚úÖ' : '-';

                        results += `<tr>
                            <td>${tc.title}</td>
                            <td>${tc.created_by || '-'}</td>
                            <td>${ownerStatus} ${tc.created_by_username || 'NULL'}</td>
                            <td>${tc.assigned_to || '-'}</td>
                            <td>${assigneeStatus} ${tc.assigned_to_username || 'NULL'}</td>
                            <td>${tc.created_by_username ? '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç' : '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td>
                        </tr>`;
                    });

                    results += '</table>';

                    // Summary
                    const withOwnerData = testCases.filter(tc => tc.created_by_username).length;
                    const total = testCases.length;

                    if (withOwnerData === total) {
                        results += '<div class="test-result success">';
                        results += `üéâ –£–°–ü–ï–•! –í—Å–µ ${total} —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∏–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤–º–µ—Å—Ç–æ UUID`;
                        results += '</div>';
                    } else {
                        results += '<div class="test-result error">';
                        results += `‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: ${withOwnerData}/${total} —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –∏–º–µ—é—Ç –¥–∞–Ω–Ω—ã–µ –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ`;
                        results += '</div>';
                    }
                }

                resultsDiv.innerHTML = results;

            } catch (error) {
                statusDiv.className = 'test-result error';
                statusDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;

                resultsDiv.innerHTML = `
                    <div class="test-result error">
                        <h3>üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏:</h3>
                        <ul>
                            <li>–°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω (–∑–∞–ø—É—Å—Ç–∏—Ç–µ START-SERVER.bat)</li>
                            <li>–ü—Ä–æ–±–ª–µ–º—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π</li>
                            <li>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞</li>
                            <li>CORS –ø–æ–ª–∏—Ç–∏–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã</li>
                        </ul>
                        <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ http://localhost:3000</p>
                    </div>
                `;
            }
        }

        // Run tests when page loads
        runTests();
    </script>
</body>
</html>